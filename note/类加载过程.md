# 类加载过程

类加载过程包括：加载、验证、准备、解析、初始化。

## 加载

### 加载过程

“加载”是“类加载”过程的一个阶段，在加载阶段，虚拟机需要完成 3 件事： 

- 通过类的全限定名获取该类的二进制字节流。 
- 将二进制字节流所代表的静态结构转化为方法区的运行时数据结构。 

- 在内存中创建一个代表该类的 java.lang.Class 对象，作为方法区这个类的各种数据的访问入口。 

### 获取二进制字节流

对于 Class 文件，虚拟机没有指明要从哪里获取、怎样获取。除了直接从编译好的 .class 文件中读取，还有以下几种方式：

- 从 zip 包中读取，如 jar、war等
- 从网络中获取，如 Applet
- 通过动态代理生成代理类的二进制字节流
- 由 JSP 文件生成对应的 Class 类
- 从数据库中读取，如 有些中间件服务器可以选择把程序安装到数据库中来完成程序代码在集群间的分发。

### 数组类与非数组类的加载

非数组类的加载阶段既可以使用系统提供的引导类加载器来完成，也可以由用户自定义的类加载器去完成，开发人员可以通过定义自己的类加载器去控制字符流的获取方式（即重写类加载器的 loadClass() 方法）。

数组类本身不通过类加载器创建，它是由 Java 虚拟机直接创建的。但是数组类的元素类型最终是要靠类加载器去创建的，一个数组类创建过程遵循以下规则：

- 如果数组的组件类型是引用类型，那就递归采用本节定义的加载过程去加载这个组件类型，数组类将在加载该组件类型的类加载器的类名称空间上被标记。
- 如果数组的组件类型不是引用类型（如 int[] 类型），Java 虚拟机会讲数组类标记为与引导类加载器关联。
- 数组类的可见性与它的组件类型的可见性一致，如果组件类型不是引用类型，那数组类的可见性默认为 public。

### 其他

加载阶段完成后，虚拟机外部的二进制字节流按照虚拟机所需的格式存储在方法区之中，方法区中的数据存储格式由虚拟机实现自行定义。然后在内存实例化一个 java.lang.Class 类对象（没有明确在 Java 堆中）。对于 HotSpot 虚拟机，Class 对象存储在方法区，作为程序访问方法区中的类型数据的外部接口。

加载阶段与连接阶段的部分内容交叉进行，加载阶段尚未完成，连接阶段可能已经开始了。但这两个阶段的开始实践仍然保持着固定的先后顺序。 

## 验证

验证是为了确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机的自身安全。

验证阶段大致有4个验证动作：文件格式验证、元数据验证、字节码验证、符号引用验证。

### 文件格式验证

验证字节流是否符合 Class 文件格式的规范，并且能被当前版本的虚拟机处理。可能包括以下验证点：

- 魔数 0xCAFEBABE 开头
- 主次版本号是否能在本虚拟机处理
- 常量池的常量是否有不被支持的常量类型（检查常量 tag 标志）
- 指向常量的各种索引值是否有指向不存在的常量或不符合类型的常量
- CONSTANT_Utf8_info 型的常量是否有不符合 UTF8 编码的数据
- .......

这个阶段的验证是基于二进制字节流进行的，只有通过了这个阶段的验证后，字节流才会进入内存的方法区中进行存储。而往后的3个阶段的验证是基于方法区的存储结构进行的，不直接操作字节流。

### 元数据验证

对类的元数据信息进行语义校验，保证不存在不符合 Java 语言规范的元数据信息。验证包括：

- 这个类是否有父类（除 Object 类之外，所有类都有父类）
- 这个类的父类是否被 final 修饰
- 如果非抽象类，是否实现了父类要求实现的所有方法
- 类的字段、方法是否与父类有矛盾
- ......

### 字节码验证

通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。即对类的方法体进行校验分析，保证被校验类的方法在运行时不会做出危害虚拟机安全的事件。



